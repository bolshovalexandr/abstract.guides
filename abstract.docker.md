## DOCKER How-To

Docker - средство упаковки, доставки и запуска приложения
Образ - неизменный (read-only) шаблон (напр., базовой ОС + код приложения + зависимости). Фактически это готовое к запуску приложение.
Образ состоит из "слоев". Например, слой Ubuntu + слой Node + слой приложения.
Контейнер - работающее приложение, созданное на базе образа. При этом на базе одного образа можно запустить множество контейнеров. Изменения в файлах контейнера никак не повлияют на образ и исчезнут при остановке контейнера.

`docker images` - список образов в системе
`docker ps` - список контейнеров

### Создание образа
1. Создаем каталог с приложением (напр., Node + ExpressJS)
2. Создаем в каталоге Dockerfile с инструкциями для создания образа

```
FROM node
RUN mkdir -p /usr/src/app
WORKDIR /usr/src/app
COPY package*.json ./
RUN npm i
COPY . .
EXPOSE 8080
ENV TZ=Europe/Moscow
CMD [ "node", "server.js" ]
```
(!)
- Каждая команда в Dockerfile создает новый слой в образе
- Аналогом CMD является ENTRYPOINT, которая выполняется без использования встроенного в базовую ОС образа командного интерпретатора
- команда EXPOSE не пробрасывает порт, а только декларирует номер открытого порта. Проброс происходит при **запуске контейнера**

3. Создаем образ
`docker build -t имя путь`, напр., `docker build -t docker-test .`

### Создание контейнера
docker run --rm -d --name отображаемое_имя -p порт_хоста:порт_контейнера имя_образа
напр.,
docker run --rm -d --name web-router -p 80:80 litest/router
--name - отображаемое имя
--rm - удаление контейнера при остановке
-d - запуск в фоне

не стоит писать параметры, такие как --rm после имени образа, докер воспринимает это как команды для Node

### переменные окружения
1. Задать непосредственно в Dockerfile, напр., ENV TZ=Europe/Moscow. Такая переменная зафиксируется в образе
2. При запуске контейнера, параметром `-e NAME=VALUE`

### Доступ к ФС
1. Монтирование реального каталога ФС хостовой ОС к каталогу в ФС контейнерной ОС
Выполняется при запуске контейнера с параметром `-v абс_путь_хостовой_ос:абс_путь_контейнерной_ос`
`docker run --rm -d --name web-router -p 80:80 -v c:\web\docker\mount:/usr/src/app/mount litest/router`
2. Использование томов (volumes) с помощью набора команд `docker volume команда`
-

### MongoDB + Docker volumes (особенности)
Выгрузка дампа на хостовую машину
`docker exec ИМЯ_КОНТЕЙНЕРА sh -c "exec mongodump --username ИМЯ --password ПАРОЛЬ -d ИМЯ_БАЗЫ --authenticationDatabase admin --archive" > all-collections.archive`
`docker exec mongo sh -c "exec mongodump --username ИМЯ --password ПАРОЛЬ -d articles --authenticationDatabase admin --archive" > all-collections.archive`

### Docker Compose

#### Основные команды
 -

- Docker volumes
- Docker networking и взаимодействие контейнеров внутри сети
- оверрайд переменных окружения